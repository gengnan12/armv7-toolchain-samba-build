name: Build Samba with ARM Official Toolchain
on:
  workflow_dispatch:

jobs:
  build-samba:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          echo "===== 安装系统依赖 ====="
          sudo apt update -y
          # 修复 libssl-dev-dev 为正确的 libssl-dev
          sudo apt install -y python3 python3-dev libssl-dev pkg-config \
                              wget tar xz-utils

      - name: Download ARMv7 toolchain (with fallback)
        run: |
          echo "===== 下载ARMv7工具链 ====="
          TOOLCHAIN_URLS=(
            "https://developer.arm.com/-/media/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-arm-linux-gnueabihf.tar.xz"
            "https://armkeil.blob.core.windows.net/developer/Files/downloads/gnu/13.2.rel1/binrel/arm-gnu-toolchain-13.2.rel1-x86_64-arm-linux-gnueabihf.tar.xz"
            "https://mirrors.tuna.tsinghua.edu.cn/armbian-releases/_toolchains/arm-gnu-toolchain-13.2.rel1-x86_64-arm-linux-gnueabihf.tar.xz"
          )
          
          for url in "${TOOLCHAIN_URLS[@]}"; do
            echo "尝试从 $url 下载..."
            if wget -q --show-progress -O arm-toolchain.tar.xz "$url" --timeout=300; then
              echo "工具链下载成功"
              break
            fi
          done
          
          if [ ! -f "arm-toolchain.tar.xz" ]; then
            echo "错误：所有链接均下载失败"
            exit 1
          fi
          
          sudo mkdir -p /opt/arm-toolchain
          sudo tar -xJf arm-toolchain.tar.xz -C /opt/arm-toolchain --strip-components=1
          echo "/opt/arm-toolchain/bin" >> $GITHUB_PATH
          arm-linux-gnueabihf-gcc --version || { echo "工具链安装失败"; exit 1; }

      - name: Download Samba source code
        run: |
          echo "===== 下载Samba源码 ====="
          SAMBA_VERSION="4.20.0"
          wget -q --show-progress https://download.samba.org/pub/samba/stable/samba-$SAMBA_VERSION.tar.gz
          tar -xzf samba-$SAMBA_VERSION.tar.gz
          cd samba-$SAMBA_VERSION
          ./configure --version > /dev/null || { echo "Samba源码损坏"; exit 1; }

      - name: Configure Samba for ARMv7
        run: |
          echo "===== 配置Samba ====="
          SAMBA_VERSION="4.20.0"
          cd samba-$SAMBA_VERSION
          ./configure \
            --host=arm-linux-gnueabihf \
            --prefix=/usr \
            --sysconfdir=/etc/samba \
            --localstatedir=/var \
            --with-privatedir=/var/lib/samba/private \
            --disable-python \
            --without-ldap \
            --without-ad-dc \
            --with-systemd=no \
            --without-winbind \
            CFLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard -Os" \
            LDFLAGS="-static-libgcc -static-libstdc++"

      - name: Compile Samba
        run: |
          echo "===== 编译Samba ====="
          SAMBA_VERSION="4.20.0"
          cd samba-$SAMBA_VERSION
          make smbd -j2 V=1
          make nmbd -j2 V=1
          make smbpasswd -j2 V=1

      - name: Verify compiled binaries
        run: |
          echo "===== 验证编译结果 ====="
          SAMBA_VERSION="4.20.0"
          file samba-$SAMBA_VERSION/bin/smbd | grep "ARM" || { echo "未生成ARM架构二进制文件"; exit 1; }
          file samba-$SAMBA_VERSION/bin/nmbd | grep "ARM" || { echo "未生成ARM架构二进制文件"; exit 1; }

      - name: Upload Samba binaries
        uses: actions/upload-artifact@v4
        with:
          name: samba420-armv7-binaries
          path: |
            samba-4.20.0/bin/smbd
            samba-4.20.0/bin/nmbd
            samba-4.20.0/bin/smbpasswd
          retention-days: 30
